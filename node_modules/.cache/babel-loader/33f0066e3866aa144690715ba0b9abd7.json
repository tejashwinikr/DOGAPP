{"ast":null,"code":"import { monitor, Observable, timeStampNow } from '@datadog/browser-core';\nimport { LifeCycleEventType } from './lifeCycle'; // Delay to wait for a page activity to validate the tracking process\n\nexport var PAGE_ACTIVITY_VALIDATION_DELAY = 100; // Delay to wait after a page activity to end the tracking process\n\nexport var PAGE_ACTIVITY_END_DELAY = 100; // Maximum duration of the tracking process\n\nexport var PAGE_ACTIVITY_MAX_DURATION = 10000;\nexport function waitIdlePageActivity(lifeCycle, domMutationObservable, configuration, completionCallback) {\n  var _a = trackPageActivities(lifeCycle, domMutationObservable),\n      pageActivitiesObservable = _a.observable,\n      stopPageActivitiesTracking = _a.stop;\n\n  var stopWaitPageActivitiesCompletion = waitPageActivitiesCompletion(pageActivitiesObservable, stopPageActivitiesTracking, configuration, completionCallback).stop;\n\n  var stop = function stop() {\n    stopWaitPageActivitiesCompletion();\n    stopPageActivitiesTracking();\n  };\n\n  return {\n    stop: stop\n  };\n} // Automatic action collection lifecycle overview:\n//                      (Start new trackPageActivities)\n//              .-------------------'--------------------.\n//              v                                        v\n//     [Wait for a page activity ]          [Wait for a maximum duration]\n//     [timeout: VALIDATION_DELAY]          [  timeout: MAX_DURATION    ]\n//          /                  \\                           |\n//         v                    v                          |\n//  [No page activity]   [Page activity]                   |\n//         |                   |,----------------------.   |\n//         v                   v                       |   |\n//     (Discard)     [Wait for a page activity]        |   |\n//                   [   timeout: END_DELAY   ]        |   |\n//                       /                \\            |   |\n//                      v                  v           |   |\n//             [No page activity]    [Page activity]   |   |\n//                      |                 |            |   |\n//                      |                 '------------'   |\n//                      '-----------. ,--------------------'\n//                                   v\n//                                 (End)\n//\n// Note: because MAX_DURATION > VALIDATION_DELAY, we are sure that if the process is still alive\n// after MAX_DURATION, it has been validated.\n\nexport function trackPageActivities(lifeCycle, domMutationObservable) {\n  var observable = new Observable();\n  var subscriptions = [];\n  var firstRequestIndex;\n  var pendingRequestsCount = 0;\n  subscriptions.push(domMutationObservable.subscribe(function () {\n    return notifyPageActivity();\n  }));\n  subscriptions.push(lifeCycle.subscribe(LifeCycleEventType.PERFORMANCE_ENTRY_COLLECTED, function (entry) {\n    if (entry.entryType !== 'resource') {\n      return;\n    }\n\n    notifyPageActivity();\n  }));\n  subscriptions.push(lifeCycle.subscribe(LifeCycleEventType.REQUEST_STARTED, function (startEvent) {\n    if (firstRequestIndex === undefined) {\n      firstRequestIndex = startEvent.requestIndex;\n    }\n\n    pendingRequestsCount += 1;\n    notifyPageActivity();\n  }));\n  subscriptions.push(lifeCycle.subscribe(LifeCycleEventType.REQUEST_COMPLETED, function (request) {\n    // If the request started before the tracking start, ignore it\n    if (firstRequestIndex === undefined || request.requestIndex < firstRequestIndex) {\n      return;\n    }\n\n    pendingRequestsCount -= 1;\n    notifyPageActivity();\n  }));\n\n  function notifyPageActivity() {\n    observable.notify({\n      isBusy: pendingRequestsCount > 0\n    });\n  }\n\n  return {\n    observable: observable,\n    stop: function stop() {\n      subscriptions.forEach(function (s) {\n        return s.unsubscribe();\n      });\n    }\n  };\n}\nexport function waitPageActivitiesCompletion(pageActivitiesObservable, stopPageActivitiesTracking, configuration, completionCallback) {\n  var idleTimeoutId;\n  var hasCompleted = false;\n  var validationTimeoutId = setTimeout(monitor(function () {\n    return complete({\n      hadActivity: false\n    });\n  }), PAGE_ACTIVITY_VALIDATION_DELAY);\n  var maxDurationTimeoutId = !configuration.isEnabled('eternal-page-activities') && setTimeout(monitor(function () {\n    return complete({\n      hadActivity: true,\n      endTime: timeStampNow()\n    });\n  }), PAGE_ACTIVITY_MAX_DURATION);\n  pageActivitiesObservable.subscribe(function (_a) {\n    var isBusy = _a.isBusy;\n    clearTimeout(validationTimeoutId);\n    clearTimeout(idleTimeoutId);\n    var lastChangeTime = timeStampNow();\n\n    if (!isBusy) {\n      idleTimeoutId = setTimeout(monitor(function () {\n        return complete({\n          hadActivity: true,\n          endTime: lastChangeTime\n        });\n      }), PAGE_ACTIVITY_END_DELAY);\n    }\n  });\n\n  var stop = function stop() {\n    hasCompleted = true;\n    clearTimeout(validationTimeoutId);\n    clearTimeout(idleTimeoutId);\n\n    if (maxDurationTimeoutId) {\n      clearTimeout(maxDurationTimeoutId);\n    }\n\n    stopPageActivitiesTracking();\n  };\n\n  function complete(params) {\n    if (hasCompleted) {\n      return;\n    }\n\n    stop();\n    completionCallback(params);\n  }\n\n  return {\n    stop: stop\n  };\n}","map":{"version":3,"mappings":"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","names":["monitor","Observable","timeStampNow","LifeCycleEventType","PAGE_ACTIVITY_VALIDATION_DELAY","PAGE_ACTIVITY_END_DELAY","PAGE_ACTIVITY_MAX_DURATION","waitIdlePageActivity","lifeCycle","domMutationObservable","configuration","completionCallback","trackPageActivities","pageActivitiesObservable","stopPageActivitiesTracking","stopWaitPageActivitiesCompletion","waitPageActivitiesCompletion","stop","observable","subscriptions","firstRequestIndex","pendingRequestsCount","push","subscribe","PERFORMANCE_ENTRY_COLLECTED","entry","entryType","notifyPageActivity","REQUEST_STARTED","startEvent","undefined","requestIndex","REQUEST_COMPLETED","request","notify","isBusy","forEach","s","unsubscribe","idleTimeoutId","hasCompleted","validationTimeoutId","setTimeout","hadActivity","maxDurationTimeoutId","isEnabled","endTime","_a","clearTimeout","lastChangeTime","complete","params"],"sourceRoot":"","sources":["../../src/domain/trackPageActivities.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}