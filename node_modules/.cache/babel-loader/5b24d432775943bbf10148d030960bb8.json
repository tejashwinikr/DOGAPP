{"ast":null,"code":"import { __assign } from \"tslib\";\nimport { addMonitoringMessage, elapsed, getPathName, includes, isValidUrl, ResourceType, toServerDuration, ONE_DAY, relativeNow, timeStampNow } from '@datadog/browser-core';\nimport { getSleepDuration } from '../../trackSleep';\nexport var FAKE_INITIAL_DOCUMENT = 'initial_document';\nvar RESOURCE_TYPES = [[ResourceType.DOCUMENT, function (initiatorType) {\n  return FAKE_INITIAL_DOCUMENT === initiatorType;\n}], [ResourceType.XHR, function (initiatorType) {\n  return 'xmlhttprequest' === initiatorType;\n}], [ResourceType.FETCH, function (initiatorType) {\n  return 'fetch' === initiatorType;\n}], [ResourceType.BEACON, function (initiatorType) {\n  return 'beacon' === initiatorType;\n}], [ResourceType.CSS, function (_, path) {\n  return /\\.css$/i.test(path);\n}], [ResourceType.JS, function (_, path) {\n  return /\\.js$/i.test(path);\n}], [ResourceType.IMAGE, function (initiatorType, path) {\n  return includes(['image', 'img', 'icon'], initiatorType) || /\\.(gif|jpg|jpeg|tiff|png|svg|ico)$/i.exec(path) !== null;\n}], [ResourceType.FONT, function (_, path) {\n  return /\\.(woff|eot|woff2|ttf)$/i.exec(path) !== null;\n}], [ResourceType.MEDIA, function (initiatorType, path) {\n  return includes(['audio', 'video'], initiatorType) || /\\.(mp3|mp4)$/i.exec(path) !== null;\n}]];\nexport function computeResourceKind(timing) {\n  var url = timing.name;\n\n  if (!isValidUrl(url)) {\n    addMonitoringMessage(\"Failed to construct URL for \\\"\" + timing.name + \"\\\"\");\n    return ResourceType.OTHER;\n  }\n\n  var path = getPathName(url);\n\n  for (var _i = 0, RESOURCE_TYPES_1 = RESOURCE_TYPES; _i < RESOURCE_TYPES_1.length; _i++) {\n    var _a = RESOURCE_TYPES_1[_i],\n        type = _a[0],\n        isType = _a[1];\n\n    if (isType(timing.initiatorType, path)) {\n      return type;\n    }\n  }\n\n  return ResourceType.OTHER;\n}\n\nfunction areInOrder() {\n  var numbers = [];\n\n  for (var _i = 0; _i < arguments.length; _i++) {\n    numbers[_i] = arguments[_i];\n  }\n\n  for (var i = 1; i < numbers.length; i += 1) {\n    if (numbers[i - 1] > numbers[i]) {\n      return false;\n    }\n  }\n\n  return true;\n}\n\nexport function isRequestKind(timing) {\n  return timing.initiatorType === 'xmlhttprequest' || timing.initiatorType === 'fetch';\n}\nexport function computePerformanceResourceDuration(entry) {\n  var duration = entry.duration,\n      startTime = entry.startTime,\n      responseEnd = entry.responseEnd; // Safari duration is always 0 on timings blocked by cross origin policies.\n\n  if (duration === 0 && startTime < responseEnd) {\n    return toServerDuration(elapsed(startTime, responseEnd));\n  }\n\n  if (duration > ONE_DAY) {\n    addMonitoringMessage('resource duration > 1 day', {\n      debug: {\n        type: entry.initiatorType,\n        name: entry.name,\n        startTime: Math.round(startTime),\n        responseEnd: Math.round(responseEnd),\n        duration: Math.round(duration),\n        relativeNow: Math.round(relativeNow()),\n        timeStampNow: timeStampNow(),\n        sleepDuration: getSleepDuration(timeStampNow() - duration)\n      }\n    });\n  }\n\n  return toServerDuration(duration);\n}\nexport function computePerformanceResourceDetails(entry) {\n  var validEntry = toValidEntry(entry);\n\n  if (!validEntry) {\n    return undefined;\n  }\n\n  var startTime = validEntry.startTime,\n      fetchStart = validEntry.fetchStart,\n      redirectStart = validEntry.redirectStart,\n      redirectEnd = validEntry.redirectEnd,\n      domainLookupStart = validEntry.domainLookupStart,\n      domainLookupEnd = validEntry.domainLookupEnd,\n      connectStart = validEntry.connectStart,\n      secureConnectionStart = validEntry.secureConnectionStart,\n      connectEnd = validEntry.connectEnd,\n      requestStart = validEntry.requestStart,\n      responseStart = validEntry.responseStart,\n      responseEnd = validEntry.responseEnd;\n  var details = {\n    download: formatTiming(startTime, responseStart, responseEnd),\n    first_byte: formatTiming(startTime, requestStart, responseStart)\n  }; // Make sure a connection occurred\n\n  if (connectEnd !== fetchStart) {\n    details.connect = formatTiming(startTime, connectStart, connectEnd); // Make sure a secure connection occurred\n\n    if (areInOrder(connectStart, secureConnectionStart, connectEnd)) {\n      details.ssl = formatTiming(startTime, secureConnectionStart, connectEnd);\n    }\n  } // Make sure a domain lookup occurred\n\n\n  if (domainLookupEnd !== fetchStart) {\n    details.dns = formatTiming(startTime, domainLookupStart, domainLookupEnd);\n  }\n\n  if (hasRedirection(entry)) {\n    details.redirect = formatTiming(startTime, redirectStart, redirectEnd);\n  }\n\n  return details;\n}\nexport function toValidEntry(entry) {\n  // Ensure timings are in the right order. On top of filtering out potential invalid\n  // RumPerformanceResourceTiming, it will ignore entries from requests where timings cannot be\n  // collected, for example cross origin requests without a \"Timing-Allow-Origin\" header allowing\n  // it.\n  if (!areInOrder(entry.startTime, entry.fetchStart, entry.domainLookupStart, entry.domainLookupEnd, entry.connectStart, entry.connectEnd, entry.requestStart, entry.responseStart, entry.responseEnd)) {\n    return undefined;\n  }\n\n  if (!hasRedirection(entry)) {\n    return entry;\n  }\n\n  var redirectStart = entry.redirectStart,\n      redirectEnd = entry.redirectEnd; // Firefox doesn't provide redirect timings on cross origin requests.\n  // Provide a default for those.\n\n  if (redirectStart < entry.startTime) {\n    redirectStart = entry.startTime;\n  }\n\n  if (redirectEnd < entry.startTime) {\n    redirectEnd = entry.fetchStart;\n  } // Make sure redirect timings are in order\n\n\n  if (!areInOrder(entry.startTime, redirectStart, redirectEnd, entry.fetchStart)) {\n    return undefined;\n  }\n\n  return __assign(__assign({}, entry), {\n    redirectEnd: redirectEnd,\n    redirectStart: redirectStart\n  });\n}\n\nfunction hasRedirection(entry) {\n  // The only time fetchStart is different than startTime is if a redirection occurred.\n  return entry.fetchStart !== entry.startTime;\n}\n\nfunction formatTiming(origin, start, end) {\n  return {\n    duration: toServerDuration(elapsed(start, end)),\n    start: toServerDuration(elapsed(origin, start))\n  };\n}\n\nexport function computeSize(entry) {\n  // Make sure a request actually occurred\n  if (entry.startTime < entry.responseStart) {\n    return entry.decodedBodySize;\n  }\n\n  return undefined;\n}\nexport function isAllowedRequestUrl(configuration, url) {\n  return url && !configuration.isIntakeUrl(url);\n}","map":{"version":3,"mappings":";AAAA,SACEA,oBADF,EAGEC,OAHF,EAIEC,WAJF,EAKEC,QALF,EAMEC,UANF,EAQEC,YARF,EAUEC,gBAVF,EAWEC,OAXF,EAYEC,WAZF,EAaEC,YAbF,QAeO,uBAfP;AAmBA,SAASC,gBAAT,QAAiC,kBAAjC;AAYA,OAAO,IAAMC,qBAAqB,GAAG,kBAA9B;AAEP,IAAMC,cAAc,GAA4E,CAC9F,CAACP,YAAY,CAACQ,QAAd,EAAwB,UAACC,aAAD,EAAsB;EAAK,4BAAqB,KAAKA,aAA1B;AAAuC,CAA1F,CAD8F,EAE9F,CAACT,YAAY,CAACU,GAAd,EAAmB,UAACD,aAAD,EAAsB;EAAK,4BAAqBA,aAArB;AAAkC,CAAhF,CAF8F,EAG9F,CAACT,YAAY,CAACW,KAAd,EAAqB,UAACF,aAAD,EAAsB;EAAK,mBAAYA,aAAZ;AAAyB,CAAzE,CAH8F,EAI9F,CAACT,YAAY,CAACY,MAAd,EAAsB,UAACH,aAAD,EAAsB;EAAK,oBAAaA,aAAb;AAA0B,CAA3E,CAJ8F,EAK9F,CAACT,YAAY,CAACa,GAAd,EAAmB,UAACC,CAAD,EAAYC,IAAZ,EAAwB;EAAK,iBAAUC,IAAV,CAAeD,IAAf;AAAoB,CAApE,CAL8F,EAM9F,CAACf,YAAY,CAACiB,EAAd,EAAkB,UAACH,CAAD,EAAYC,IAAZ,EAAwB;EAAK,gBAASC,IAAT,CAAcD,IAAd;AAAmB,CAAlE,CAN8F,EAO9F,CACEf,YAAY,CAACkB,KADf,EAEE,UAACT,aAAD,EAAwBM,IAAxB,EAAoC;EAClC,eAAQ,CAAC,CAAC,OAAD,EAAU,KAAV,EAAiB,MAAjB,CAAD,EAA2BN,aAA3B,CAAR,IAAqD,sCAAsCU,IAAtC,CAA2CJ,IAA3C,MAAqD,IAA1G;AAA8G,CAHlH,CAP8F,EAY9F,CAACf,YAAY,CAACoB,IAAd,EAAoB,UAACN,CAAD,EAAYC,IAAZ,EAAwB;EAAK,kCAA2BI,IAA3B,CAAgCJ,IAAhC,MAA0C,IAA1C;AAA8C,CAA/F,CAZ8F,EAa9F,CACEf,YAAY,CAACqB,KADf,EAEE,UAACZ,aAAD,EAAwBM,IAAxB,EAAoC;EAClC,eAAQ,CAAC,CAAC,OAAD,EAAU,OAAV,CAAD,EAAqBN,aAArB,CAAR,IAA+C,gBAAgBU,IAAhB,CAAqBJ,IAArB,MAA+B,IAA9E;AAAkF,CAHtF,CAb8F,CAAhG;AAoBA,OAAM,SAAUO,mBAAV,CAA8BC,MAA9B,EAAkE;EACtE,IAAMC,GAAG,GAAGD,MAAM,CAACE,IAAnB;;EACA,IAAI,CAAC1B,UAAU,CAACyB,GAAD,CAAf,EAAsB;IACpB7B,oBAAoB,CAAC,mCAAgC4B,MAAM,CAACE,IAAvC,GAA2C,IAA5C,CAApB;IACA,OAAOzB,YAAY,CAAC0B,KAApB;EACD;;EACD,IAAMX,IAAI,GAAGlB,WAAW,CAAC2B,GAAD,CAAxB;;EACA,KAA6B,6CAA7B,EAA6BG,4BAA7B,EAA6BA,IAA7B,EAA6C;IAAlC;IAAA,IAACC,IAAI,QAAL;IAAA,IAAOC,MAAM,QAAb;;IACT,IAAIA,MAAM,CAACN,MAAM,CAACd,aAAR,EAAuBM,IAAvB,CAAV,EAAwC;MACtC,OAAOa,IAAP;IACD;EACF;;EACD,OAAO5B,YAAY,CAAC0B,KAApB;AACD;;AAED,SAASI,UAAT,GAAmB;EAAC;;OAAA,yCAAoB;IAApBC;;;EAClB,KAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGD,OAAO,CAACE,MAA5B,EAAoCD,CAAC,IAAI,CAAzC,EAA4C;IAC1C,IAAID,OAAO,CAACC,CAAC,GAAG,CAAL,CAAP,GAAiBD,OAAO,CAACC,CAAD,CAA5B,EAAiC;MAC/B,OAAO,KAAP;IACD;EACF;;EACD,OAAO,IAAP;AACD;;AAED,OAAM,SAAUE,aAAV,CAAwBX,MAAxB,EAA4D;EAChE,OAAOA,MAAM,CAACd,aAAP,KAAyB,gBAAzB,IAA6Cc,MAAM,CAACd,aAAP,KAAyB,OAA7E;AACD;AAED,OAAM,SAAU0B,kCAAV,CAA6CC,KAA7C,EAAgF;EAC5E,YAAQ,GAA6BA,KAAK,SAA1C;EAAA,IAAUC,SAAS,GAAkBD,KAAK,UAA1C;EAAA,IAAqBE,WAAW,GAAKF,KAAK,YAA1C,CAD4E,CAGpF;;EACA,IAAIG,QAAQ,KAAK,CAAb,IAAkBF,SAAS,GAAGC,WAAlC,EAA+C;IAC7C,OAAOrC,gBAAgB,CAACL,OAAO,CAACyC,SAAD,EAAYC,WAAZ,CAAR,CAAvB;EACD;;EAED,IAAIC,QAAQ,GAAGrC,OAAf,EAAwB;IACtBP,oBAAoB,CAAC,2BAAD,EAA8B;MAChD6C,KAAK,EAAE;QACLZ,IAAI,EAAEQ,KAAK,CAAC3B,aADP;QAELgB,IAAI,EAAEW,KAAK,CAACX,IAFP;QAGLY,SAAS,EAAEI,IAAI,CAACC,KAAL,CAAWL,SAAX,CAHN;QAILC,WAAW,EAAEG,IAAI,CAACC,KAAL,CAAWJ,WAAX,CAJR;QAKLC,QAAQ,EAAEE,IAAI,CAACC,KAAL,CAAWH,QAAX,CALL;QAMLpC,WAAW,EAAEsC,IAAI,CAACC,KAAL,CAAWvC,WAAW,EAAtB,CANR;QAOLC,YAAY,EAAEA,YAAY,EAPrB;QAQLuC,aAAa,EAAEtC,gBAAgB,CAAED,YAAY,KAAKmC,QAAnB;MAR1B;IADyC,CAA9B,CAApB;EAYD;;EAED,OAAOtC,gBAAgB,CAACsC,QAAD,CAAvB;AACD;AAED,OAAM,SAAUK,iCAAV,CACJR,KADI,EAC+B;EAEnC,IAAMS,UAAU,GAAGC,YAAY,CAACV,KAAD,CAA/B;;EAEA,IAAI,CAACS,UAAL,EAAiB;IACf,OAAOE,SAAP;EACD;;EAEC,aAAS,GAYPF,UAAU,UAZZ;EAAA,IACAG,UAAU,GAWRH,UAAU,WAZZ;EAAA,IAEAI,aAAa,GAUXJ,UAAU,cAZZ;EAAA,IAGAK,WAAW,GASTL,UAAU,YAZZ;EAAA,IAIAM,iBAAiB,GAQfN,UAAU,kBAZZ;EAAA,IAKAO,eAAe,GAObP,UAAU,gBAZZ;EAAA,IAMAQ,YAAY,GAMVR,UAAU,aAZZ;EAAA,IAOAS,qBAAqB,GAKnBT,UAAU,sBAZZ;EAAA,IAQAU,UAAU,GAIRV,UAAU,WAZZ;EAAA,IASAW,YAAY,GAGVX,UAAU,aAZZ;EAAA,IAUAY,aAAa,GAEXZ,UAAU,cAZZ;EAAA,IAWAP,WAAW,GACTO,UAAU,YAZZ;EAcF,IAAMa,OAAO,GAA+B;IAC1CC,QAAQ,EAAEC,YAAY,CAACvB,SAAD,EAAYoB,aAAZ,EAA2BnB,WAA3B,CADoB;IAE1CuB,UAAU,EAAED,YAAY,CAACvB,SAAD,EAAYmB,YAAZ,EAA0BC,aAA1B;EAFkB,CAA5C,CAtBmC,CA2BnC;;EACA,IAAIF,UAAU,KAAKP,UAAnB,EAA+B;IAC7BU,OAAO,CAACI,OAAR,GAAkBF,YAAY,CAACvB,SAAD,EAAYgB,YAAZ,EAA0BE,UAA1B,CAA9B,CAD6B,CAG7B;;IACA,IAAIzB,UAAU,CAACuB,YAAD,EAAeC,qBAAf,EAAsCC,UAAtC,CAAd,EAAiE;MAC/DG,OAAO,CAACK,GAAR,GAAcH,YAAY,CAACvB,SAAD,EAAYiB,qBAAZ,EAAmCC,UAAnC,CAA1B;IACD;EACF,CAnCkC,CAqCnC;;;EACA,IAAIH,eAAe,KAAKJ,UAAxB,EAAoC;IAClCU,OAAO,CAACM,GAAR,GAAcJ,YAAY,CAACvB,SAAD,EAAYc,iBAAZ,EAA+BC,eAA/B,CAA1B;EACD;;EAED,IAAIa,cAAc,CAAC7B,KAAD,CAAlB,EAA2B;IACzBsB,OAAO,CAACQ,QAAR,GAAmBN,YAAY,CAACvB,SAAD,EAAYY,aAAZ,EAA2BC,WAA3B,CAA/B;EACD;;EAED,OAAOQ,OAAP;AACD;AAED,OAAM,SAAUZ,YAAV,CAAuBV,KAAvB,EAA0D;EAC9D;EACA;EACA;EACA;EACA,IACE,CAACN,UAAU,CACTM,KAAK,CAACC,SADG,EAETD,KAAK,CAACY,UAFG,EAGTZ,KAAK,CAACe,iBAHG,EAITf,KAAK,CAACgB,eAJG,EAKThB,KAAK,CAACiB,YALG,EAMTjB,KAAK,CAACmB,UANG,EAOTnB,KAAK,CAACoB,YAPG,EAQTpB,KAAK,CAACqB,aARG,EASTrB,KAAK,CAACE,WATG,CADb,EAYE;IACA,OAAOS,SAAP;EACD;;EAED,IAAI,CAACkB,cAAc,CAAC7B,KAAD,CAAnB,EAA4B;IAC1B,OAAOA,KAAP;EACD;;EAEK,iBAAa,GAAkBA,KAAK,cAApC;EAAA,IAAec,WAAW,GAAKd,KAAK,YAApC,CAzBwD,CA0B9D;EACA;;EACA,IAAIa,aAAa,GAAGb,KAAK,CAACC,SAA1B,EAAqC;IACnCY,aAAa,GAAGb,KAAK,CAACC,SAAtB;EACD;;EACD,IAAIa,WAAW,GAAGd,KAAK,CAACC,SAAxB,EAAmC;IACjCa,WAAW,GAAGd,KAAK,CAACY,UAApB;EACD,CAjC6D,CAmC9D;;;EACA,IAAI,CAAClB,UAAU,CAACM,KAAK,CAACC,SAAP,EAAkBY,aAAlB,EAAiCC,WAAjC,EAA8Cd,KAAK,CAACY,UAApD,CAAf,EAAgF;IAC9E,OAAOD,SAAP;EACD;;EAED,6BACKX,KADL,GACU;IACRc,WAAW,aADH;IAERD,aAAa;EAFL,CADV;AAKD;;AAED,SAASgB,cAAT,CAAwB7B,KAAxB,EAA2D;EACzD;EACA,OAAOA,KAAK,CAACY,UAAN,KAAqBZ,KAAK,CAACC,SAAlC;AACD;;AAED,SAASuB,YAAT,CAAsBO,MAAtB,EAA4CC,KAA5C,EAAiEC,GAAjE,EAAkF;EAChF,OAAO;IACL9B,QAAQ,EAAEtC,gBAAgB,CAACL,OAAO,CAACwE,KAAD,EAAQC,GAAR,CAAR,CADrB;IAELD,KAAK,EAAEnE,gBAAgB,CAACL,OAAO,CAACuE,MAAD,EAASC,KAAT,CAAR;EAFlB,CAAP;AAID;;AAED,OAAM,SAAUE,WAAV,CAAsBlC,KAAtB,EAAyD;EAC7D;EACA,IAAIA,KAAK,CAACC,SAAN,GAAkBD,KAAK,CAACqB,aAA5B,EAA2C;IACzC,OAAOrB,KAAK,CAACmC,eAAb;EACD;;EACD,OAAOxB,SAAP;AACD;AAED,OAAM,SAAUyB,mBAAV,CAA8BC,aAA9B,EAA4DjD,GAA5D,EAAuE;EAC3E,OAAOA,GAAG,IAAI,CAACiD,aAAa,CAACC,WAAd,CAA0BlD,GAA1B,CAAf;AACD","names":["addMonitoringMessage","elapsed","getPathName","includes","isValidUrl","ResourceType","toServerDuration","ONE_DAY","relativeNow","timeStampNow","getSleepDuration","FAKE_INITIAL_DOCUMENT","RESOURCE_TYPES","DOCUMENT","initiatorType","XHR","FETCH","BEACON","CSS","_","path","test","JS","IMAGE","exec","FONT","MEDIA","computeResourceKind","timing","url","name","OTHER","_i","type","isType","areInOrder","numbers","i","length","isRequestKind","computePerformanceResourceDuration","entry","startTime","responseEnd","duration","debug","Math","round","sleepDuration","computePerformanceResourceDetails","validEntry","toValidEntry","undefined","fetchStart","redirectStart","redirectEnd","domainLookupStart","domainLookupEnd","connectStart","secureConnectionStart","connectEnd","requestStart","responseStart","details","download","formatTiming","first_byte","connect","ssl","dns","hasRedirection","redirect","origin","start","end","computeSize","decodedBodySize","isAllowedRequestUrl","configuration","isIntakeUrl"],"sourceRoot":"","sources":["../../../../src/domain/rumEventsCollection/resource/resourceUtils.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}