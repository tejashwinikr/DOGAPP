{"ast":null,"code":"import { __assign } from \"tslib\";\nimport { elapsed, generateUUID, monitor, ONE_MINUTE, throttle, clocksNow, clocksOrigin, timeStampNow, display } from '@datadog/browser-core';\nimport { ViewLoadingType } from '../../../rawRumEvent.types';\nimport { LifeCycleEventType } from '../../lifeCycle';\nimport { trackInitialViewTimings } from './trackInitialViewTimings';\nimport { trackLocationChanges, areDifferentLocation } from './trackLocationChanges';\nimport { trackViewMetrics } from './trackViewMetrics';\nexport var THROTTLE_VIEW_UPDATE_PERIOD = 3000;\nexport var SESSION_KEEP_ALIVE_INTERVAL = 5 * ONE_MINUTE;\nexport function trackViews(location, lifeCycle, domMutationObservable, areViewsTrackedAutomatically, configuration, initialViewName) {\n  var _a = trackInitialView(initialViewName),\n      stopInitialViewTracking = _a.stop,\n      initialView = _a.initialView;\n\n  var currentView = initialView;\n  var stopViewLifeCycle = startViewLifeCycle().stop;\n  var stopViewCollectionMode = (areViewsTrackedAutomatically ? startAutomaticViewCollection() : startManualViewCollection()).stop;\n\n  function trackInitialView(name) {\n    var initialView = newView(lifeCycle, domMutationObservable, location, ViewLoadingType.INITIAL_LOAD, document.referrer, configuration, clocksOrigin(), name);\n    var stop = trackInitialViewTimings(lifeCycle, function (timings) {\n      initialView.updateTimings(timings);\n      initialView.scheduleUpdate();\n    }).stop;\n    return {\n      initialView: initialView,\n      stop: stop\n    };\n  }\n\n  function trackViewChange(startClocks, name) {\n    return newView(lifeCycle, domMutationObservable, location, ViewLoadingType.ROUTE_CHANGE, currentView.url, configuration, startClocks, name);\n  }\n\n  function startViewLifeCycle() {\n    lifeCycle.subscribe(LifeCycleEventType.SESSION_RENEWED, function () {\n      // do not trigger view update to avoid wrong data\n      currentView.end(); // Renew view on session renewal\n\n      currentView = trackViewChange(undefined, currentView.name);\n    }); // End the current view on page unload\n\n    lifeCycle.subscribe(LifeCycleEventType.BEFORE_UNLOAD, function () {\n      currentView.end();\n      currentView.triggerUpdate();\n    }); // Session keep alive\n\n    var keepAliveInterval = window.setInterval(monitor(function () {\n      currentView.triggerUpdate();\n    }), SESSION_KEEP_ALIVE_INTERVAL);\n    return {\n      stop: function stop() {\n        clearInterval(keepAliveInterval);\n      }\n    };\n  }\n\n  function startAutomaticViewCollection() {\n    return trackLocationChanges(function () {\n      if (areDifferentLocation(currentView.getLocation(), location)) {\n        // Renew view on location changes\n        currentView.end();\n        currentView.triggerUpdate();\n        currentView = trackViewChange();\n        return;\n      }\n\n      currentView.updateLocation(location);\n      currentView.triggerUpdate();\n    });\n  }\n\n  function startManualViewCollection() {\n    return trackLocationChanges(function () {\n      currentView.updateLocation(location);\n      currentView.triggerUpdate();\n    });\n  }\n\n  return {\n    addTiming: function addTiming(name, time) {\n      if (time === void 0) {\n        time = timeStampNow();\n      }\n\n      currentView.addTiming(name, time);\n      currentView.triggerUpdate();\n    },\n    startView: function startView(name, startClocks) {\n      currentView.end(startClocks);\n      currentView.triggerUpdate();\n      currentView = trackViewChange(startClocks, name);\n    },\n    stop: function stop() {\n      stopViewCollectionMode();\n      stopInitialViewTracking();\n      stopViewLifeCycle();\n      currentView.end();\n    }\n  };\n}\n\nfunction newView(lifeCycle, domMutationObservable, initialLocation, loadingType, referrer, configuration, startClocks, name) {\n  if (startClocks === void 0) {\n    startClocks = clocksNow();\n  } // Setup initial values\n\n\n  var id = generateUUID();\n  var timings = {};\n  var customTimings = {};\n  var documentVersion = 0;\n  var endClocks;\n\n  var location = __assign({}, initialLocation);\n\n  lifeCycle.notify(LifeCycleEventType.VIEW_CREATED, {\n    id: id,\n    name: name,\n    startClocks: startClocks,\n    location: location,\n    referrer: referrer\n  }); // Update the view every time the measures are changing\n\n  var _a = throttle(monitor(triggerViewUpdate), THROTTLE_VIEW_UPDATE_PERIOD, {\n    leading: false\n  }),\n      scheduleViewUpdate = _a.throttled,\n      cancelScheduleViewUpdate = _a.cancel;\n\n  var _b = trackViewMetrics(lifeCycle, domMutationObservable, scheduleViewUpdate, loadingType, configuration),\n      setLoadEvent = _b.setLoadEvent,\n      stopViewMetricsTracking = _b.stop,\n      viewMetrics = _b.viewMetrics; // Initial view update\n\n\n  triggerViewUpdate();\n\n  function triggerViewUpdate() {\n    documentVersion += 1;\n    var currentEnd = endClocks === undefined ? timeStampNow() : endClocks.timeStamp;\n    lifeCycle.notify(LifeCycleEventType.VIEW_UPDATED, __assign(__assign({}, viewMetrics), {\n      customTimings: customTimings,\n      documentVersion: documentVersion,\n      id: id,\n      name: name,\n      loadingType: loadingType,\n      location: location,\n      referrer: referrer,\n      startClocks: startClocks,\n      timings: timings,\n      duration: elapsed(startClocks.timeStamp, currentEnd),\n      isActive: endClocks === undefined\n    }));\n  }\n\n  return {\n    name: name,\n    scheduleUpdate: scheduleViewUpdate,\n    end: function end(clocks) {\n      if (clocks === void 0) {\n        clocks = clocksNow();\n      }\n\n      endClocks = clocks;\n      stopViewMetricsTracking();\n      lifeCycle.notify(LifeCycleEventType.VIEW_ENDED, {\n        endClocks: endClocks\n      });\n    },\n    getLocation: function getLocation() {\n      return location;\n    },\n    triggerUpdate: function triggerUpdate() {\n      // cancel any pending view updates execution\n      cancelScheduleViewUpdate();\n      triggerViewUpdate();\n    },\n    updateTimings: function updateTimings(newTimings) {\n      timings = newTimings;\n\n      if (newTimings.loadEvent !== undefined) {\n        setLoadEvent(newTimings.loadEvent);\n      }\n    },\n    addTiming: function addTiming(name, time) {\n      customTimings[sanitizeTiming(name)] = elapsed(startClocks.timeStamp, time);\n    },\n    updateLocation: function updateLocation(newLocation) {\n      location = __assign({}, newLocation);\n    },\n\n    get url() {\n      return location.href;\n    }\n\n  };\n}\n/**\n * Timing name is used as facet path that must contain only letters, digits, or the characters - _ . @ $\n */\n\n\nfunction sanitizeTiming(name) {\n  var sanitized = name.replace(/[^a-zA-Z0-9-_.@$]/g, '_');\n\n  if (sanitized !== name) {\n    display.warn(\"Invalid timing name: \" + name + \", sanitized to: \" + sanitized);\n  }\n\n  return sanitized;\n}","map":{"version":3,"mappings":";AAAA,SAEEA,OAFF,EAGEC,YAHF,EAIEC,OAJF,EAKEC,UALF,EAMEC,QANF,EAQEC,SARF,EASEC,YATF,EAUEC,YAVF,EAYEC,OAZF,QAcO,uBAdP;AAgBA,SAASC,eAAT,QAAmD,4BAAnD;AAEA,SAAoBC,kBAApB,QAA8C,iBAA9C;AAEA,SAAkBC,uBAAlB,QAAiD,2BAAjD;AACA,SAASC,oBAAT,EAA+BC,oBAA/B,QAA2D,wBAA3D;AACA,SAASC,gBAAT,QAAiC,oBAAjC;AA+BA,OAAO,IAAMC,2BAA2B,GAAG,IAApC;AACP,OAAO,IAAMC,2BAA2B,GAAG,IAAIb,UAAxC;AAEP,OAAM,SAAUc,UAAV,CACJC,QADI,EAEJC,SAFI,EAGJC,qBAHI,EAIJC,4BAJI,EAKJC,aALI,EAMJC,eANI,EAMoB;EAElB,SAAiDC,gBAAgB,CAACD,eAAD,CAAjE;EAAA,IAAQE,uBAAuB,UAA/B;EAAA,IAAiCC,WAAW,iBAA5C;;EACN,IAAIC,WAAW,GAAGD,WAAlB;EAEQ,IAAME,iBAAiB,GAAKC,kBAAkB,GAAEC,IAAhD;EACA,IAAMC,sBAAsB,GAAK,6BAA4B,GACjEC,4BAA4B,EADqC,GAEjEC,yBAAyB,EAFY,EAEVH,IAFvB;;EAIR,SAASN,gBAAT,CAA0BU,IAA1B,EAAuC;IACrC,IAAMR,WAAW,GAAGS,OAAO,CACzBhB,SADyB,EAEzBC,qBAFyB,EAGzBF,QAHyB,EAIzBT,eAAe,CAAC2B,YAJS,EAKzBC,QAAQ,CAACC,QALgB,EAMzBhB,aANyB,EAOzBhB,YAAY,EAPa,EAQzB4B,IARyB,CAA3B;IAUQ,QAAI,GAAKvB,uBAAuB,CAACQ,SAAD,EAAY,UAACoB,OAAD,EAAQ;MAC1Db,WAAW,CAACc,aAAZ,CAA0BD,OAA1B;MACAb,WAAW,CAACe,cAAZ;IACD,CAHuC,CAAvB,CAGfX,IAHM;IAIR,OAAO;MAAEJ,WAAW,aAAb;MAAeI,IAAI;IAAnB,CAAP;EACD;;EAED,SAASY,eAAT,CAAyBC,WAAzB,EAAoDT,IAApD,EAAiE;IAC/D,OAAOC,OAAO,CACZhB,SADY,EAEZC,qBAFY,EAGZF,QAHY,EAIZT,eAAe,CAACmC,YAJJ,EAKZjB,WAAW,CAACkB,GALA,EAMZvB,aANY,EAOZqB,WAPY,EAQZT,IARY,CAAd;EAUD;;EAED,SAASL,kBAAT,GAA2B;IACzBV,SAAS,CAAC2B,SAAV,CAAoBpC,kBAAkB,CAACqC,eAAvC,EAAwD;MACtD;MACApB,WAAW,CAACqB,GAAZ,GAFsD,CAGtD;;MACArB,WAAW,GAAGe,eAAe,CAACO,SAAD,EAAYtB,WAAW,CAACO,IAAxB,CAA7B;IACD,CALD,EADyB,CAQzB;;IACAf,SAAS,CAAC2B,SAAV,CAAoBpC,kBAAkB,CAACwC,aAAvC,EAAsD;MACpDvB,WAAW,CAACqB,GAAZ;MACArB,WAAW,CAACwB,aAAZ;IACD,CAHD,EATyB,CAczB;;IACA,IAAMC,iBAAiB,GAAGC,MAAM,CAACC,WAAP,CACxBpD,OAAO,CAAC;MACNyB,WAAW,CAACwB,aAAZ;IACD,CAFM,CADiB,EAIxBnC,2BAJwB,CAA1B;IAOA,OAAO;MACLc,IAAI,EAAE;QACJyB,aAAa,CAACH,iBAAD,CAAb;MACD;IAHI,CAAP;EAKD;;EAED,SAASpB,4BAAT,GAAqC;IACnC,OAAOpB,oBAAoB,CAAC;MAC1B,IAAIC,oBAAoB,CAACc,WAAW,CAAC6B,WAAZ,EAAD,EAA4BtC,QAA5B,CAAxB,EAA+D;QAC7D;QACAS,WAAW,CAACqB,GAAZ;QACArB,WAAW,CAACwB,aAAZ;QACAxB,WAAW,GAAGe,eAAe,EAA7B;QACA;MACD;;MACDf,WAAW,CAAC8B,cAAZ,CAA2BvC,QAA3B;MACAS,WAAW,CAACwB,aAAZ;IACD,CAV0B,CAA3B;EAWD;;EAED,SAASlB,yBAAT,GAAkC;IAChC,OAAOrB,oBAAoB,CAAC;MAC1Be,WAAW,CAAC8B,cAAZ,CAA2BvC,QAA3B;MACAS,WAAW,CAACwB,aAAZ;IACD,CAH0B,CAA3B;EAID;;EAED,OAAO;IACLO,SAAS,EAAE,mBAACxB,IAAD,EAAeyB,IAAf,EAAoC;MAArB;QAAAA,OAAOpD,YAAY,EAAnB;MAAqB;;MAC7CoB,WAAW,CAAC+B,SAAZ,CAAsBxB,IAAtB,EAA4ByB,IAA5B;MACAhC,WAAW,CAACwB,aAAZ;IACD,CAJI;IAKLS,SAAS,EAAE,mBAAC1B,IAAD,EAAgBS,WAAhB,EAAyC;MAClDhB,WAAW,CAACqB,GAAZ,CAAgBL,WAAhB;MACAhB,WAAW,CAACwB,aAAZ;MACAxB,WAAW,GAAGe,eAAe,CAACC,WAAD,EAAcT,IAAd,CAA7B;IACD,CATI;IAULJ,IAAI,EAAE;MACJC,sBAAsB;MACtBN,uBAAuB;MACvBG,iBAAiB;MACjBD,WAAW,CAACqB,GAAZ;IACD;EAfI,CAAP;AAiBD;;AAED,SAASb,OAAT,CACEhB,SADF,EAEEC,qBAFF,EAGEyC,eAHF,EAIEC,WAJF,EAKExB,QALF,EAMEhB,aANF,EAOEqB,WAPF,EAQET,IARF,EAQe;EADb;IAAAS,cAA2BtC,SAAS,EAApC;EAAsC,CACzB,CAEb;;;EACA,IAAM0D,EAAE,GAAG9D,YAAY,EAAvB;EACA,IAAIsC,OAAO,GAAY,EAAvB;EACA,IAAMyB,aAAa,GAAsB,EAAzC;EACA,IAAIC,eAAe,GAAG,CAAtB;EACA,IAAIC,SAAJ;;EACA,IAAIhD,QAAQ,gBAAQ2C,eAAR,CAAZ;;EAEA1C,SAAS,CAACgD,MAAV,CAAiBzD,kBAAkB,CAAC0D,YAApC,EAAkD;IAAEL,EAAE,IAAJ;IAAM7B,IAAI,MAAV;IAAYS,WAAW,aAAvB;IAAyBzB,QAAQ,UAAjC;IAAmCoB,QAAQ;EAA3C,CAAlD,EAVa,CAYb;;EACM,SAAsElC,QAAQ,CAClFF,OAAO,CAACmE,iBAAD,CAD2E,EAElFtD,2BAFkF,EAGlF;IACEuD,OAAO,EAAE;EADX,CAHkF,CAA9E;EAAA,IAAaC,kBAAkB,eAA/B;EAAA,IAAyCC,wBAAwB,YAAjE;;EAQA,SAA+D1D,gBAAgB,CACnFK,SADmF,EAEnFC,qBAFmF,EAGnFmD,kBAHmF,EAInFT,WAJmF,EAKnFxC,aALmF,CAA/E;EAAA,IAAEmD,YAAY,kBAAd;EAAA,IAAsBC,uBAAuB,UAA7C;EAAA,IAA+CC,WAAW,iBAA1D,CArBO,CA6Bb;;;EACAN,iBAAiB;;EAEjB,SAASA,iBAAT,GAA0B;IACxBJ,eAAe,IAAI,CAAnB;IACA,IAAMW,UAAU,GAAGV,SAAS,KAAKjB,SAAd,GAA0B1C,YAAY,EAAtC,GAA2C2D,SAAS,CAACW,SAAxE;IACA1D,SAAS,CAACgD,MAAV,CAAiBzD,kBAAkB,CAACoE,YAApC,EAAgDC,sBAC3CJ,WAD2C,GAChC;MACdX,aAAa,eADC;MAEdC,eAAe,iBAFD;MAGdF,EAAE,IAHY;MAId7B,IAAI,MAJU;MAKd4B,WAAW,aALG;MAMd5C,QAAQ,UANM;MAOdoB,QAAQ,UAPM;MAQdK,WAAW,aARG;MASdJ,OAAO,SATO;MAUdyC,QAAQ,EAAEhF,OAAO,CAAC2C,WAAW,CAACkC,SAAb,EAAwBD,UAAxB,CAVH;MAWdK,QAAQ,EAAEf,SAAS,KAAKjB;IAXV,CADgC,CAAhD;EAcD;;EAED,OAAO;IACLf,IAAI,MADC;IAELO,cAAc,EAAE8B,kBAFX;IAGLvB,GAAG,eAACkC,MAAD,EAAqB;MAApB;QAAAA,SAAS7E,SAAS,EAAlB;MAAoB;;MACtB6D,SAAS,GAAGgB,MAAZ;MACAR,uBAAuB;MACvBvD,SAAS,CAACgD,MAAV,CAAiBzD,kBAAkB,CAACyE,UAApC,EAAgD;QAAEjB,SAAS;MAAX,CAAhD;IACD,CAPI;IAQLV,WAAW;MACT,OAAOtC,QAAP;IACD,CAVI;IAWLiC,aAAa;MACX;MACAqB,wBAAwB;MACxBH,iBAAiB;IAClB,CAfI;IAgBL7B,aAAa,EAAb,uBAAc4C,UAAd,EAAiC;MAC/B7C,OAAO,GAAG6C,UAAV;;MACA,IAAIA,UAAU,CAACC,SAAX,KAAyBpC,SAA7B,EAAwC;QACtCwB,YAAY,CAACW,UAAU,CAACC,SAAZ,CAAZ;MACD;IACF,CArBI;IAsBL3B,SAAS,EAAT,mBAAUxB,IAAV,EAAwByB,IAAxB,EAAuC;MACrCK,aAAa,CAACsB,cAAc,CAACpD,IAAD,CAAf,CAAb,GAAsClC,OAAO,CAAC2C,WAAW,CAACkC,SAAb,EAAwBlB,IAAxB,CAA7C;IACD,CAxBI;IAyBLF,cAAc,EAAd,wBAAe8B,WAAf,EAAoC;MAClCrE,QAAQ,gBAAQqE,WAAR,CAAR;IACD,CA3BI;;IA4BL,IAAI1C,GAAJ,GAAO;MACL,OAAO3B,QAAQ,CAACsE,IAAhB;IACD;;EA9BI,CAAP;AAgCD;AAED;;;;;AAGA,SAASF,cAAT,CAAwBpD,IAAxB,EAAoC;EAClC,IAAMuD,SAAS,GAAGvD,IAAI,CAACwD,OAAL,CAAa,oBAAb,EAAmC,GAAnC,CAAlB;;EACA,IAAID,SAAS,KAAKvD,IAAlB,EAAwB;IACtB1B,OAAO,CAACmF,IAAR,CAAa,0BAAwBzD,IAAxB,GAA4B,kBAA5B,GAA+CuD,SAA5D;EACD;;EACD,OAAOA,SAAP;AACD","names":["elapsed","generateUUID","monitor","ONE_MINUTE","throttle","clocksNow","clocksOrigin","timeStampNow","display","ViewLoadingType","LifeCycleEventType","trackInitialViewTimings","trackLocationChanges","areDifferentLocation","trackViewMetrics","THROTTLE_VIEW_UPDATE_PERIOD","SESSION_KEEP_ALIVE_INTERVAL","trackViews","location","lifeCycle","domMutationObservable","areViewsTrackedAutomatically","configuration","initialViewName","trackInitialView","stopInitialViewTracking","initialView","currentView","stopViewLifeCycle","startViewLifeCycle","stop","stopViewCollectionMode","startAutomaticViewCollection","startManualViewCollection","name","newView","INITIAL_LOAD","document","referrer","timings","updateTimings","scheduleUpdate","trackViewChange","startClocks","ROUTE_CHANGE","url","subscribe","SESSION_RENEWED","end","undefined","BEFORE_UNLOAD","triggerUpdate","keepAliveInterval","window","setInterval","clearInterval","getLocation","updateLocation","addTiming","time","startView","initialLocation","loadingType","id","customTimings","documentVersion","endClocks","notify","VIEW_CREATED","triggerViewUpdate","leading","scheduleViewUpdate","cancelScheduleViewUpdate","setLoadEvent","stopViewMetricsTracking","viewMetrics","currentEnd","timeStamp","VIEW_UPDATED","__assign","duration","isActive","clocks","VIEW_ENDED","newTimings","loadEvent","sanitizeTiming","newLocation","href","sanitized","replace","warn"],"sourceRoot":"","sources":["../../../../src/domain/rumEventsCollection/view/trackViews.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}