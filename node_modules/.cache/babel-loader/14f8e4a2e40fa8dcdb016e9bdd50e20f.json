{"ast":null,"code":"import { noop, addEventListener, elapsed, relativeNow, addMonitoringMessage, toServerDuration } from '@datadog/browser-core'; // Arbitrary value to cap number of element (mostly for backend)\n\nexport var MAX_NUMBER_OF_FOCUSED_TIME = 500; // ignore duplicate focus & blur events if coming in the right after the previous one\n// chrome bug: https://bugs.chromium.org/p/chromium/issues/detail?id=1237904\n\nvar MAX_TIME_TO_IGNORE_DUPLICATE = 10;\nvar foregroundPeriods = [];\nexport function startForegroundContexts(configuration) {\n  if (!configuration.isEnabled('track-foreground')) {\n    return {\n      getInForeground: function getInForeground() {\n        return undefined;\n      },\n      getInForegroundPeriods: function getInForegroundPeriods() {\n        return undefined;\n      },\n      stop: noop\n    };\n  }\n\n  if (document.hasFocus()) {\n    addNewForegroundPeriod();\n  }\n\n  var stopForegroundTracking = trackFocus(addNewForegroundPeriod).stop;\n  var stopBlurTracking = trackBlur(closeForegroundPeriod).stop;\n  return {\n    getInForeground: getInForeground,\n    getInForegroundPeriods: getInForegroundPeriods,\n    stop: function stop() {\n      foregroundPeriods = [];\n      stopForegroundTracking();\n      stopBlurTracking();\n    }\n  };\n}\nexport function addNewForegroundPeriod() {\n  if (foregroundPeriods.length > MAX_NUMBER_OF_FOCUSED_TIME) {\n    addMonitoringMessage('Reached maximum of foreground time');\n    return;\n  }\n\n  var currentForegroundPeriod = foregroundPeriods[foregroundPeriods.length - 1];\n  var now = relativeNow();\n\n  if (currentForegroundPeriod !== undefined && currentForegroundPeriod.end === undefined) {\n    if (now - currentForegroundPeriod.start > MAX_TIME_TO_IGNORE_DUPLICATE) {\n      addMonitoringMessage('Previous foreground periods not closed. Continuing current one', {\n        foregroundPeriods: {\n          count: foregroundPeriods.length,\n          currentStart: currentForegroundPeriod.start,\n          now: now,\n          diff: now - currentForegroundPeriod.start\n        }\n      });\n    }\n\n    return;\n  }\n\n  foregroundPeriods.push({\n    start: now\n  });\n}\nexport function closeForegroundPeriod() {\n  if (foregroundPeriods.length === 0) {\n    addMonitoringMessage('No foreground period');\n    return;\n  }\n\n  var currentForegroundPeriod = foregroundPeriods[foregroundPeriods.length - 1];\n  var now = relativeNow();\n\n  if (currentForegroundPeriod.end !== undefined) {\n    if (now - currentForegroundPeriod.end > MAX_TIME_TO_IGNORE_DUPLICATE) {\n      addMonitoringMessage('Current foreground period already closed', {\n        foregroundPeriods: {\n          count: foregroundPeriods.length,\n          currentStart: currentForegroundPeriod.start,\n          currentEnd: currentForegroundPeriod.end,\n          now: now,\n          diff: now - currentForegroundPeriod.end\n        },\n        now: relativeNow()\n      });\n    }\n\n    return;\n  }\n\n  currentForegroundPeriod.end = now;\n}\n\nfunction trackFocus(onFocusChange) {\n  return addEventListener(window, \"focus\"\n  /* FOCUS */\n  , function (event) {\n    if (!event.isTrusted) {\n      return;\n    }\n\n    onFocusChange();\n  });\n}\n\nfunction trackBlur(onBlurChange) {\n  return addEventListener(window, \"blur\"\n  /* BLUR */\n  , function (event) {\n    if (!event.isTrusted) {\n      return;\n    }\n\n    onBlurChange();\n  });\n}\n\nfunction getInForeground(startTime) {\n  for (var i = foregroundPeriods.length - 1; i >= 0; i--) {\n    var foregroundPeriod = foregroundPeriods[i];\n\n    if (foregroundPeriod.end !== undefined && startTime > foregroundPeriod.end) {\n      break;\n    }\n\n    if (startTime > foregroundPeriod.start && (foregroundPeriod.end === undefined || startTime < foregroundPeriod.end)) {\n      return true;\n    }\n  }\n\n  return false;\n}\n\nfunction getInForegroundPeriods(eventStartTime, duration) {\n  // eslint-disable-next-line @typescript-eslint/restrict-plus-operands\n  var eventEndTime = eventStartTime + duration;\n  var filteredForegroundPeriods = [];\n\n  for (var i = foregroundPeriods.length - 1; i >= 0; i--) {\n    var foregroundPeriod = foregroundPeriods[i];\n\n    if (foregroundPeriod.end !== undefined && eventStartTime > foregroundPeriod.end) {\n      // event starts after the end of the current focus period\n      // since the array is sorted, we can stop looking for foreground periods\n      break;\n    }\n\n    if (eventEndTime < foregroundPeriod.start) {\n      // event ends before the start of the current focus period\n      // continue to previous one\n      continue;\n    }\n\n    var startTime = eventStartTime > foregroundPeriod.start ? eventStartTime : foregroundPeriod.start;\n    var startDuration = elapsed(eventStartTime, startTime);\n    var endTime = foregroundPeriod.end === undefined || eventEndTime < foregroundPeriod.end ? eventEndTime : foregroundPeriod.end;\n    var endDuration = elapsed(startTime, endTime);\n    filteredForegroundPeriods.unshift({\n      start: toServerDuration(startDuration),\n      duration: toServerDuration(endDuration)\n    });\n  }\n\n  return filteredForegroundPeriods;\n}","map":{"version":3,"mappings":"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","names":["noop","addEventListener","elapsed","relativeNow","addMonitoringMessage","toServerDuration","MAX_NUMBER_OF_FOCUSED_TIME","MAX_TIME_TO_IGNORE_DUPLICATE","foregroundPeriods","startForegroundContexts","configuration","isEnabled","getInForeground","getInForegroundPeriods","stop","document","hasFocus","addNewForegroundPeriod","stopForegroundTracking","trackFocus","stopBlurTracking","trackBlur","closeForegroundPeriod","length","currentForegroundPeriod","now","undefined","end","start","count","currentStart","diff","push","currentEnd","onFocusChange","window","event","isTrusted","onBlurChange","startTime","i","foregroundPeriod","eventStartTime","duration","eventEndTime","filteredForegroundPeriods","startDuration","endTime","endDuration","unshift"],"sourceRoot":"","sources":["../../src/domain/foregroundContexts.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}