{"ast":null,"code":"import { __assign } from \"tslib\";\nimport { addEventListeners, getRelativeTime, isNumber, monitor, relativeNow, runOnReadyState } from '@datadog/browser-core';\nimport { LifeCycleEventType } from '../domain/lifeCycle';\nimport { FAKE_INITIAL_DOCUMENT, isAllowedRequestUrl } from '../domain/rumEventsCollection/resource/resourceUtils';\nimport { getDocumentTraceId } from '../domain/tracing/getDocumentTraceId';\n\nfunction supportPerformanceObject() {\n  return window.performance !== undefined && 'getEntries' in performance;\n}\n\nexport function supportPerformanceTimingEvent(entryType) {\n  return window.PerformanceObserver && PerformanceObserver.supportedEntryTypes !== undefined && PerformanceObserver.supportedEntryTypes.includes(entryType);\n}\nexport function supportPerformanceEntry() {\n  // Safari 10 doesn't support PerformanceEntry\n  return typeof PerformanceEntry === 'function';\n}\nexport function startPerformanceCollection(lifeCycle, configuration) {\n  retrieveInitialDocumentResourceTiming(function (timing) {\n    handleRumPerformanceEntry(lifeCycle, configuration, timing);\n  });\n\n  if (supportPerformanceObject()) {\n    handlePerformanceEntries(lifeCycle, configuration, performance.getEntries());\n  }\n\n  if (window.PerformanceObserver) {\n    var handlePerformanceEntryList_1 = monitor(function (entries) {\n      return handlePerformanceEntries(lifeCycle, configuration, entries.getEntries());\n    });\n    var mainEntries = ['resource', 'navigation', 'longtask', 'paint'];\n    var experimentalEntries = ['largest-contentful-paint', 'first-input', 'layout-shift'];\n\n    try {\n      // Experimental entries are not retrieved by performance.getEntries()\n      // use a single PerformanceObserver with buffered flag by type\n      // to get values that could happen before SDK init\n      experimentalEntries.forEach(function (type) {\n        var observer = new PerformanceObserver(handlePerformanceEntryList_1);\n        observer.observe({\n          type: type,\n          buffered: true\n        });\n      });\n    } catch (e) {\n      // Some old browser versions don't support PerformanceObserver without entryTypes option\n      mainEntries.push.apply(mainEntries, experimentalEntries);\n    }\n\n    var mainObserver = new PerformanceObserver(handlePerformanceEntryList_1);\n    mainObserver.observe({\n      entryTypes: mainEntries\n    });\n\n    if (supportPerformanceObject() && 'addEventListener' in performance) {\n      // https://bugzilla.mozilla.org/show_bug.cgi?id=1559377\n      performance.addEventListener('resourcetimingbufferfull', function () {\n        performance.clearResourceTimings();\n      });\n    }\n  }\n\n  if (!supportPerformanceTimingEvent('navigation')) {\n    retrieveNavigationTiming(function (timing) {\n      handleRumPerformanceEntry(lifeCycle, configuration, timing);\n    });\n  }\n\n  if (!supportPerformanceTimingEvent('first-input')) {\n    retrieveFirstInputTiming(function (timing) {\n      handleRumPerformanceEntry(lifeCycle, configuration, timing);\n    });\n  }\n}\nexport function retrieveInitialDocumentResourceTiming(callback) {\n  runOnReadyState('interactive', function () {\n    var timing;\n    var forcedAttributes = {\n      entryType: 'resource',\n      initiatorType: FAKE_INITIAL_DOCUMENT,\n      traceId: getDocumentTraceId(document)\n    };\n\n    if (supportPerformanceTimingEvent('navigation') && performance.getEntriesByType('navigation').length > 0) {\n      var navigationEntry = performance.getEntriesByType('navigation')[0];\n      timing = __assign(__assign({}, navigationEntry.toJSON()), forcedAttributes);\n    } else {\n      var relativePerformanceTiming = computeRelativePerformanceTiming();\n      timing = __assign(__assign(__assign({}, relativePerformanceTiming), {\n        decodedBodySize: 0,\n        duration: relativePerformanceTiming.responseEnd,\n        name: window.location.href,\n        startTime: 0\n      }), forcedAttributes);\n    }\n\n    callback(timing);\n  });\n}\n\nfunction retrieveNavigationTiming(callback) {\n  function sendFakeTiming() {\n    callback(__assign(__assign({}, computeRelativePerformanceTiming()), {\n      entryType: 'navigation'\n    }));\n  }\n\n  runOnReadyState('complete', function () {\n    // Send it a bit after the actual load event, so the \"loadEventEnd\" timing is accurate\n    setTimeout(monitor(sendFakeTiming));\n  });\n}\n/**\n * first-input timing entry polyfill based on\n * https://github.com/GoogleChrome/web-vitals/blob/master/src/lib/polyfills/firstInputPolyfill.ts\n */\n\n\nfunction retrieveFirstInputTiming(callback) {\n  var startTimeStamp = Date.now();\n  var timingSent = false;\n  var removeEventListeners = addEventListeners(window, [\"click\"\n  /* CLICK */\n  , \"mousedown\"\n  /* MOUSE_DOWN */\n  , \"keydown\"\n  /* KEY_DOWN */\n  , \"touchstart\"\n  /* TOUCH_START */\n  , \"pointerdown\"\n  /* POINTER_DOWN */\n  ], function (evt) {\n    // Only count cancelable events, which should trigger behavior important to the user.\n    if (!evt.cancelable) {\n      return;\n    } // This timing will be used to compute the \"first Input delay\", which is the delta between\n    // when the system received the event (e.g. evt.timeStamp) and when it could run the callback\n    // (e.g. performance.now()).\n\n\n    var timing = {\n      entryType: 'first-input',\n      processingStart: relativeNow(),\n      startTime: evt.timeStamp\n    };\n\n    if (evt.type === \"pointerdown\"\n    /* POINTER_DOWN */\n    ) {\n      sendTimingIfPointerIsNotCancelled(timing);\n    } else {\n      sendTiming(timing);\n    }\n  }, {\n    passive: true,\n    capture: true\n  }).stop;\n  /**\n   * Pointer events are a special case, because they can trigger main or compositor thread behavior.\n   * We differentiate these cases based on whether or not we see a pointercancel event, which are\n   * fired when we scroll. If we're scrolling we don't need to report input delay since FID excludes\n   * scrolling and pinch/zooming.\n   */\n\n  function sendTimingIfPointerIsNotCancelled(timing) {\n    addEventListeners(window, [\"pointerup\"\n    /* POINTER_UP */\n    , \"pointercancel\"\n    /* POINTER_CANCEL */\n    ], function (event) {\n      if (event.type === \"pointerup\"\n      /* POINTER_UP */\n      ) {\n        sendTiming(timing);\n      }\n    }, {\n      once: true\n    });\n  }\n\n  function sendTiming(timing) {\n    if (!timingSent) {\n      timingSent = true;\n      removeEventListeners(); // In some cases the recorded delay is clearly wrong, e.g. it's negative or it's larger than\n      // the time between now and when the page was loaded.\n      // - https://github.com/GoogleChromeLabs/first-input-delay/issues/4\n      // - https://github.com/GoogleChromeLabs/first-input-delay/issues/6\n      // - https://github.com/GoogleChromeLabs/first-input-delay/issues/7\n\n      var delay = timing.processingStart - timing.startTime;\n\n      if (delay >= 0 && delay < Date.now() - startTimeStamp) {\n        callback(timing);\n      }\n    }\n  }\n}\n\nfunction computeRelativePerformanceTiming() {\n  var result = {};\n  var timing = performance.timing;\n\n  for (var key in timing) {\n    if (isNumber(timing[key])) {\n      var numberKey = key; // eslint-disable-next-line @typescript-eslint/no-unnecessary-type-assertion\n\n      var timingElement = timing[numberKey];\n      result[numberKey] = timingElement === 0 ? 0 : getRelativeTime(timingElement);\n    }\n  }\n\n  return result;\n}\n\nfunction handlePerformanceEntries(lifeCycle, configuration, entries) {\n  entries.forEach(function (entry) {\n    if (entry.entryType === 'resource' || entry.entryType === 'navigation' || entry.entryType === 'paint' || entry.entryType === 'longtask' || entry.entryType === 'largest-contentful-paint' || entry.entryType === 'first-input' || entry.entryType === 'layout-shift') {\n      handleRumPerformanceEntry(lifeCycle, configuration, entry);\n    }\n  });\n}\n\nfunction handleRumPerformanceEntry(lifeCycle, configuration, entry) {\n  if (isIncompleteNavigation(entry) || isForbiddenResource(configuration, entry)) {\n    return;\n  }\n\n  lifeCycle.notify(LifeCycleEventType.PERFORMANCE_ENTRY_COLLECTED, entry);\n}\n\nfunction isIncompleteNavigation(entry) {\n  return entry.entryType === 'navigation' && entry.loadEventEnd <= 0;\n}\n\nfunction isForbiddenResource(configuration, entry) {\n  return entry.entryType === 'resource' && !isAllowedRequestUrl(configuration, entry.name);\n}","map":{"version":3,"mappings":"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","names":["addEventListeners","getRelativeTime","isNumber","monitor","relativeNow","runOnReadyState","LifeCycleEventType","FAKE_INITIAL_DOCUMENT","isAllowedRequestUrl","getDocumentTraceId","supportPerformanceObject","window","performance","undefined","supportPerformanceTimingEvent","entryType","PerformanceObserver","supportedEntryTypes","includes","supportPerformanceEntry","PerformanceEntry","startPerformanceCollection","lifeCycle","configuration","retrieveInitialDocumentResourceTiming","timing","handleRumPerformanceEntry","handlePerformanceEntries","getEntries","handlePerformanceEntryList_1","entries","mainEntries","experimentalEntries","forEach","type","observer","observe","buffered","e","push","apply","mainObserver","entryTypes","addEventListener","clearResourceTimings","retrieveNavigationTiming","retrieveFirstInputTiming","callback","forcedAttributes","initiatorType","traceId","document","getEntriesByType","length","navigationEntry","toJSON","relativePerformanceTiming","computeRelativePerformanceTiming","decodedBodySize","duration","responseEnd","name","location","href","startTime","sendFakeTiming","setTimeout","startTimeStamp","Date","now","timingSent","removeEventListeners","evt","cancelable","processingStart","timeStamp","sendTimingIfPointerIsNotCancelled","sendTiming","passive","capture","stop","event","once","delay","result","key","numberKey","timingElement","entry","isIncompleteNavigation","isForbiddenResource","notify","PERFORMANCE_ENTRY_COLLECTED","loadEventEnd"],"sourceRoot":"","sources":["../../src/browser/performanceCollection.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}